<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="client.css">
    <script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>
  </head>
 
  <body>

  <h1>Index</h1>
  <ul id="chat_area">
    
  </ul>
  <form id="nickname_form">
    <label>Nickname:</label>
    <input id="nickname" type="text">
    <button>Submit</button>
  </form>
  <form id="message_form">
    <label>Message: </label>
    <input id="message" type="text">
    <button>Submit</button>
  </form>
  <p id="users">Current users:</p>
  
  <!-- this will be on the main page -->
  <iframe id="spotifyPlayer" frameborder="0" allowtransparency="true" width="800px"></iframe>

  <div id="queue"></div>  

  <!-- this will be on the main page -->

  <!-- this will be the guest user page -->
  <div class="btn-group btn-group-justified" role="group" aria-label="...">
    <div class="btn-group" role="group">
      <button type="button" onclick="searchForTracks()" class="btn btn-default">Search</button>
    </div>
    <div class="btn-group" role="group">
      <button type="button" onclick="getPlaylist()" class="btn btn-default">UpVote/DownVote</button>
    </div>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-default">Exit</button>
    </div>
  </div>

  <div id="autocomplete" class="center-block" style="margin-top: 20px; margin-bottom: 20px;">
    <input id="search" placeholder="Search for Tracks" class="center-block"></input>
  </div>

  <table id="tableResults" class="table table-striped col-md-12">
    <thead>
      <tr>
        <th class="text-center">Track Name</th>
        <th class="text-center">Artist</th>
        <th class="text-center">Preview</th>
        <th class="text-center"></th>  
      </tr>
    </thead>
    <tbody id="searchResults">
    </tbody>
  </table>

  <script>
    $(document).ready(function() {

      playDefault = function(){
        // 222240
        var default_src = `https://embed.spotify.com/?uri=spotify:trackset:PREFEREDTITLE:2xmJNIkGmYBVoiu1WqA9il`;
        $("#spotifyPlayer").attr("src", default_src);
      };

      playNow = function(track) {

      }
      
      addTrackToPlaylist = function(track_id, track_name, artist){
        getTrackDuration(track_id);

        var $li = `<li>${track_name} : ${artist}</li>`
        $('#queue').append($li);

        // var src = `https://embed.spotify.com/?uri=spotify:trackset:PREFEREDTITLE:${current_track}`;
        
        // $("#spotifyPlayer").attr("src", src);
        
      }

      displayResult = function(track) {
        var artists = [];
        
        track.artists.forEach(function(artist){
          artists.push(artist.name);
        })

        var artist = artists.join(' / ');

        var addToPlaylist = `<button onclick="addTrackToPlaylist('${track.id}', '${track.name}', '${artist}')" class="btn btn-danger btn-xs">Add to Playlist</button>`;
        var row = `<tr id="${track.id}">
                    <td class="text-center">${track.name}</td>
                    <td class="text-center">${artist}</<td>
                    <td class="text-center">
                      <audio controls>
                        <source src="${track.preview_url}" type="audio/ogg">
                        <source src="${track.preview_url}" type="audio/mpeg">
                      </audio>
                    <td class="text-center">${addToPlaylist}</td>
                   </tr>`;
        $('tbody').append(row);
      }

      searchForTracks = function(){

        $("#tableResults, #search").show();

        $("#search").on("keyup", function(e) {

          var query = $("#search").val();
          var searchTrack = query.split(' ').join('+');

          if(query.length > 0) {

            $.ajax({
              url: `https://api.spotify.com/v1/search?q=${searchTrack}&type=track&market=CA&limit=5&offset=0`,
              method: 'GET',
              success: function(response) {     

                $("#searchResults").empty();
                $("#tableResults").show();
                response.tracks.items.forEach(function(track){
                  displayResult(track);
                })

              },
              error: function(error) {
                console.log(error); 
              }
            }); 
          }
        });

      }

      getPlaylist = function(){
        $("#tableResults, #search").hide();

        // get the playlist from the main app 
        console.log("Gets the playlist")       

      }

      getTrackDuration = function(track_id){
        $.ajax({
          url: `https://api.spotify.com/v1/tracks/${track_id}`,
          method: 'GET',
          success: function(response) {     

            console.log(response.duration_ms)

          },
          error: function(error) {
            console.log(error); 
          }
        }); 
      }

      playDefault();

      $("#tableResults, #search").hide();


    });

  </script>
  <script src='/socket.io/socket.io.js'></script>  
  <script>
    var socket = io();
    $('#nickname_form').submit(function(){
      socket.emit('name submit', $('#nickname').val());
      $('#nickname_form').hide();
      $('#message_form').show();
      return false;
    })
    $('#message_form').submit(function(){
      socket.emit('chat message', $('#message').val());
      $('#message').val('');
      return false;
    })
    socket.on('chat message', function(message){
      $('#chat_area').append('<li>' + message);
    })
    socket.on('name submit', function(name){
      $('#users').append(name + '');
    })
  </script>

  </body>
</html>


